# Project Structure & File Organization

This document defines the strict file structure for the **Bun-Native Email Microservice**.
The architecture follows a **Modular Monolith** pattern where a single `src` directory contains logic for API, Workers, and Core Libraries.

## Root Directory

```text
/ (root)
├── Dockerfile                  # Multi-stage build (Source -> Dist)
├── compose.yml                 # Local development infrastructure (Postgres + Redis)
├── package.json                # Dependencies and scripts
├── bun.lockb                   # Binary lockfile (Bun native)
├── tsconfig.json               # TypeScript configuration
├── drizzle.config.ts           # Drizzle ORM configuration
├── .env.example                # Template for environment variables
├── .docs/                      # Project Context (PRD, TDD, Context, Schema)
│
├── drizzle/                    # SQL Migrations generated by Drizzle Kit
│   └── 0000_initial.sql
│
├── templates/                  # [DEV ONLY] Local source for .tsx templates
│   ├── emails/                 # Actual email components
│   └── components/             # Shared UI components (Button, Text, etc.)
│
└── src/                        # Application Source Code
```

## Source Code Structure (src/)

The src folder is the entry point for the compiled application.

```text
src/
├── index.ts                    # Main Entrypoint. Switches between 'API', 'WORKER', or 'DEV' roles based on env.
├── config.ts                   # Type-safe environment variable loader (using Zod/TypeBox)
│
├── api/                        # [ROLE: API] REST Server Logic (ElysiaJS)
│   ├── server.ts               # App setup and middleware registration
│   ├── routes.ts               # Route definitions
│   ├── middlewares/            # Auth, RateLimit, ErrorHandling
│   └── controllers/            # HTTP Handlers (Validation -> Service Call -> Response)
│       ├── send.controller.ts
│       ├── webhook.controller.ts
│       └── client.controller.ts
│
├── worker/                     # [ROLE: WORKER] Background Job Processing
│   ├── index.ts                # Worker initialization
│   └── processors/             # BullMQ Sandboxed Processors
│       └── email.processor.ts  # Handles the 'email:send' job
│
└── lib/                        # Shared Domain Logic & Adapters
    ├── db/                     # Database Access
    │   ├── index.ts            # Drizzle client instance
    │   ├── schema.ts           # Table definitions (Clients, Messages)
    │   └── redis.ts            # Shared Redis client (ioredis)
    │
    ├── queue/                  # Queue Management
    │   └── client.ts           # BullMQ Queue instance (for producers)
    │
    ├── engine/                 # [CORE] Template Rendering Engine
    │   ├── loader.ts           # Main orchestrator (Check Cache -> Build -> Load)
    │   ├── builder.ts          # Bun.build wrapper (Source -> Dist)
    │   ├── locker.ts           # Distributed Locking logic (Redis)
    │   └── renderer.ts         # React Email render logic
    │
    └── providers/              # Email Provider Adapters
        ├── interface.ts        # 'EmailProvider' interface definition
        ├── manager.ts          # Circuit Breaker & Failover logic
        ├── smtp.ts             # SMTP Implementation
        └── aws-ses.ts          # AWS SES Implementation
``` 

## Key Directories Explanation

1. `src/index.ts`: The "Traffic Controller". It checks `process.env.SERVICE_ROLE`. If it's `API`, it imports `src/api/server.ts`. If `WORKER`, it imports `src/worker/index.ts`.
2. `src/lib/engine/`: This is the heart of the "Lazy Compilation" system. It must be kept independent of the API or Worker so it can be used by both (or tested in isolation).
3. `templates/`: This folder is mounted as a read-only volume at `/app/templates-src` inside the container. It is NOT part of the build artifact, it is data provided at runtime.
4. `drizzle/`: Stores the SQL migration files. These are applied at startup or via a separate migration command.

## Rules for AI Generation
* Do NOT create `apps/` or `packages/` folders. This is a single-package repository.
* Do NOT put business logic inside `controllers`. Controllers should parse input and call `lib/` services.
* Always place Redis connections in `lib/db/redis.ts` to ensure singleton usage across the app.